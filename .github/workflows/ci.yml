name: FastAPI CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  alembic-check:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install alembic sqlalchemy
          pip install -e .
      
      - name: Check for multiple heads
        env:
          # MySQL ì—°ê²° ì •ë³´
          DB_DIALECT: mysql
          DB_DRIVER: pymysql
          DB_HOST: "127.0.0.1"
          DB_PORT: "3306"
          DB_USER: "root"
          DB_PASSWORD: "test_password"
          DB_DATABASE: "test_db"
          ACCESS_TOKEN_SECRET: "test-secret-for-ci"
          REFRESH_TOKEN_SECRET: "test-secret-for-ci"
        run: |
          echo "ğŸ” Alembic ë‹¤ì¤‘ í—¤ë“œ ì²´í¬..."
          HEAD_COUNT=$(alembic heads 2>/dev/null | wc -l)
          
          if [ "$HEAD_COUNT" -gt 1 ]; then
            echo "::error::ë‹¤ì¤‘ ë§ˆì´ê·¸ë ˆì´ì…˜ í—¤ë“œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo ""
            echo "í˜„ì¬ í—¤ë“œ ëª©ë¡:"
            alembic heads
            echo ""
            echo "í•´ê²° ë°©ë²•: alembic merge heads -m 'merge_migrations'"
            exit 1
          fi
          
          echo "âœ… ë‹¨ì¼ ë§ˆì´ê·¸ë ˆì´ì…˜ í—¤ë“œ í™•ì¸"
          alembic heads
      
      - name: Verify migration chain
        env:
          # MySQL ì—°ê²° ì •ë³´
          DB_DIALECT: mysql
          DB_DRIVER: pymysql
          DB_HOST: "127.0.0.1"
          DB_PORT: "3306"
          DB_USER: "root"
          DB_PASSWORD: "test_password"
          DB_DATABASE: "test_db"
          ACCESS_TOKEN_SECRET: "test-secret-for-ci"
          REFRESH_TOKEN_SECRET: "test-secret-for-ci"
        run: |
          echo "ğŸ”— ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´ì¸ ê²€ì¦..."
          alembic history --verbose
          
          # MySQLë¡œ ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰í•˜ì—¬ ê²€ì¦
          echo "ğŸ“ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì¤‘..."
          
          if ! alembic upgrade head 2>&1 | tee /tmp/migration.log; then
            echo "::error::ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!"
            cat /tmp/migration.log
            exit 1
          fi
          
          # Python ì—ëŸ¬ë‚˜ Tracebackì´ ìˆëŠ”ì§€ í™•ì¸
          if grep -E "Traceback|Error:|Exception:" /tmp/migration.log | grep -v "INFO"; then
            echo "::error::ë§ˆì´ê·¸ë ˆì´ì…˜ì— Python ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤!"
            cat /tmp/migration.log
            exit 1
          fi
          
          echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´ì¸ ì •ìƒ"

  import-check:
    runs-on: ubuntu-latest
    needs: [alembic-check]  # ì´ì „ jobë“¤ í†µê³¼ í›„ ì‹¤í–‰
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install -e .
      
      - name: ëª¨ë“  ëª¨ë“ˆ Import ê²€ì¦
        env:
          # í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ê°’ (ì‹¤ì œ DB ì—°ê²° ì—†ì´ importë§Œ ê²€ì¦)
          DB_DIALECT: mysql
          DB_DRIVER: pymysql
          DB_HOST: "127.0.0.1"
          DB_PORT: "3306"
          DB_USER: "test_user"
          DB_PASSWORD: "test_password"
          DB_DATABASE: "test_db"
          ACCESS_TOKEN_SECRET: "test-secret-for-ci"
          REFRESH_TOKEN_SECRET: "test-secret-for-ci"
        run: |
          echo "ğŸ“¦ ëª¨ë“  Python ëª¨ë“ˆ import í…ŒìŠ¤íŠ¸..."
          python -c "
          import sys
          import importlib
          import pkgutil
          
          errors = []
          
          # ë©”ì¸ íŒ¨í‚¤ì§€ import
          try:
              import asset_management
              print('âœ… asset_management íŒ¨í‚¤ì§€ import ì„±ê³µ')
          except Exception as e:
              errors.append(f'asset_management: {e}')
              print(f'âŒ asset_management: {e}')
          
          # ëª¨ë“  ì„œë¸Œëª¨ë“ˆ import
          modules = [
              'asset_management.main',
              'asset_management.app.user.routes',
              'asset_management.app.user.models',
              'asset_management.app.auth.router',
              'asset_management.app.auth.models',
              'asset_management.app.auth.services',
              'asset_management.app.club.routes',
              'asset_management.app.club.models',
              'asset_management.app.assets.router',
              'asset_management.app.assets.models',
              'asset_management.app.assets.services',
              'asset_management.app.schedule.models',
              'asset_management.app.club_member.router',
              'asset_management.app.admin.routes',
              'asset_management.app.category.models',
              'asset_management.database.session',
          ]
          
          for module in modules:
              try:
                  importlib.import_module(module)
                  print(f'âœ… {module}')
              except Exception as e:
                  errors.append(f'{module}: {e}')
                  print(f'âŒ {module}: {e}')
          
          if errors:
              print(f'\nâŒ {len(errors)}ê°œ ëª¨ë“ˆì—ì„œ import ì—ëŸ¬ ë°œìƒ!')
              sys.exit(1)
          else:
              print(f'\nâœ… ëª¨ë“  ëª¨ë“ˆ import ì„±ê³µ!')
          "

  app-startup-check:
    runs-on: ubuntu-latest
    needs: [import-check]  # import ì²´í¬ í†µê³¼ í›„ ì‹¤í–‰
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install -e .
      
      - name: FastAPI ì•± ì‹œì‘ í…ŒìŠ¤íŠ¸
        env:
          # í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ê°’ (ì‹¤ì œ DB ì—°ê²° ì—†ì´ ì•± ë¡œë“œë§Œ ê²€ì¦)
          DB_DIALECT: sqlite
          DB_DRIVER: pysqlite
          DB_HOST: ""
          DB_PORT: "0"
          DB_USER: ""
          DB_PASSWORD: ""
          DB_DATABASE: ":memory:"
          ACCESS_TOKEN_SECRET: "test-secret-for-ci"
          REFRESH_TOKEN_SECRET: "test-secret-for-ci"
        run: |
          echo "ğŸš€ FastAPI ì•± ì‹œì‘ ê²€ì¦..."
          python -c "
          import sys
          try:
              # DB ìŠ¤í‚¤ë§ˆ ë¨¼ì € ìƒì„±
              from asset_management.database.common import Base
              from asset_management.database.session import ENGINE
              from asset_management.database import import_models
              import_models()
              Base.metadata.create_all(bind=ENGINE)
              
              from asset_management.main import app
              
              # FastAPI ì•± ê°ì²´ ê²€ì¦
              assert app is not None, 'appì´ Noneì…ë‹ˆë‹¤'
              assert hasattr(app, 'routes'), 'routes ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤'
              
              # ë¼ìš°í„° ë“±ë¡ í™•ì¸
              route_paths = [route.path for route in app.routes]
              print(f'ë“±ë¡ëœ ë¼ìš°íŠ¸ ìˆ˜: {len(route_paths)}')
              
              # í•„ìˆ˜ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
              required_endpoints = ['/health', '/api']
              for endpoint in required_endpoints:
                  if any(endpoint in path for path in route_paths):
                      print(f'âœ… {endpoint} ì—”ë“œí¬ì¸íŠ¸ í™•ì¸')
                  else:
                      print(f'âš ï¸ {endpoint} ì—”ë“œí¬ì¸íŠ¸ ë¯¸í™•ì¸')
              
              print('âœ… FastAPI ì•± ë¡œë“œ ì„±ê³µ!')
          except Exception as e:
              print(f'âŒ FastAPI ì•± ë¡œë“œ ì‹¤íŒ¨: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
      
      - name: OpenAPI ìŠ¤í‚¤ë§ˆ ìƒì„± í…ŒìŠ¤íŠ¸
        env:
          # í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ê°’
          DB_DIALECT: sqlite
          DB_DRIVER: pysqlite
          DB_HOST: ""
          DB_PORT: "0"
          DB_USER: ""
          DB_PASSWORD: ""
          DB_DATABASE: ":memory:"
          ACCESS_TOKEN_SECRET: "test-secret-for-ci"
          REFRESH_TOKEN_SECRET: "test-secret-for-ci"
        run: |
          echo "ğŸ“„ OpenAPI ìŠ¤í‚¤ë§ˆ ìƒì„± í…ŒìŠ¤íŠ¸..."
          python -c "
          # DB ìŠ¤í‚¤ë§ˆ ë¨¼ì € ìƒì„±
          from asset_management.database.common import Base
          from asset_management.database.session import ENGINE
          from asset_management.database import import_models
          import_models()
          Base.metadata.create_all(bind=ENGINE)
          
          from asset_management.main import app
          schema = app.openapi()
          assert 'paths' in schema, 'OpenAPI ìŠ¤í‚¤ë§ˆì— pathsê°€ ì—†ìŠµë‹ˆë‹¤'
          assert 'info' in schema, 'OpenAPI ìŠ¤í‚¤ë§ˆì— infoê°€ ì—†ìŠµë‹ˆë‹¤'
          print(f'âœ… OpenAPI ìŠ¤í‚¤ë§ˆ ìƒì„± ì„±ê³µ ({len(schema[\"paths\"])} ì—”ë“œí¬ì¸íŠ¸)')
          "

  test:
    runs-on: ubuntu-latest
    needs: [app-startup-check]  # app-startup-check í†µê³¼ í›„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-asyncio httpx
      
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          # ì¸ë©”ëª¨ë¦¬ SQLiteë¡œ í…ŒìŠ¤íŠ¸
          DB_DIALECT: sqlite
          DB_DRIVER: pysqlite
          DB_HOST: ""
          DB_PORT: "0"
          DB_USER: ""
          DB_PASSWORD: ""
          DB_DATABASE: ":memory:"
          ACCESS_TOKEN_SECRET: "test-secret-for-ci"
          REFRESH_TOKEN_SECRET: "test-secret-for-ci"
        run: |
          echo "ğŸ§ª pytest ì‹¤í–‰..."
          pytest tests/ -v --tb=short

  # ëª¨ë“  ì²´í¬ í†µê³¼ í™•ì¸ (Branch Protectionì— ì‚¬ìš©)
  ci-success:
    runs-on: ubuntu-latest
    needs: [alembic-check, import-check, app-startup-check, test]
    steps:
      - name: CI ì„±ê³µ
        run: echo "âœ… ëª¨ë“  CI ì²´í¬ í†µê³¼!"
