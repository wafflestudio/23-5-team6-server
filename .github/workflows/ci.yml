name: FastAPI CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install -e .
          pip install ruff mypy pytest pytest-asyncio httpx
      
      - name: Ruff ë¦°íŠ¸ ì²´í¬
        run: |
          echo "ğŸ” Ruff ë¦°íŠ¸ ê²€ì‚¬ ì¤‘..."
          ruff check . --output-format=github
      
      - name: Ruff í¬ë§· ì²´í¬
        run: |
          echo "ğŸ“ ì½”ë“œ í¬ë§· ê²€ì‚¬ ì¤‘..."
          ruff format --check .
      
      - name: MyPy íƒ€ì… ì²´í¬
        run: |
          echo "ğŸ” íƒ€ì… ì²´í¬ ì¤‘..."
          mypy asset_management --ignore-missing-imports --no-error-summary || true
        continue-on-error: true  # ì²˜ìŒì—ëŠ” warningìœ¼ë¡œ ì‹œì‘

  import-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install -e .
      
      - name: ëª¨ë“  ëª¨ë“ˆ Import ê²€ì¦
        run: |
          echo "ğŸ“¦ ëª¨ë“  Python ëª¨ë“ˆ import í…ŒìŠ¤íŠ¸..."
          python -c "
          import sys
          import importlib
          import pkgutil
          
          errors = []
          
          # ë©”ì¸ íŒ¨í‚¤ì§€ import
          try:
              import asset_management
              print('âœ… asset_management íŒ¨í‚¤ì§€ import ì„±ê³µ')
          except Exception as e:
              errors.append(f'asset_management: {e}')
              print(f'âŒ asset_management: {e}')
          
          # ëª¨ë“  ì„œë¸Œëª¨ë“ˆ import
          modules = [
              'asset_management.main',
              'asset_management.app.user.routes',
              'asset_management.app.user.models',
              'asset_management.app.auth.router',
              'asset_management.app.auth.models',
              'asset_management.app.auth.services',
              'asset_management.app.club.routes',
              'asset_management.app.club.models',
              'asset_management.app.assets.router',
              'asset_management.app.assets.models',
              'asset_management.app.assets.services',
              'asset_management.app.schedule.models',
              'asset_management.app.club_member.router',
              'asset_management.app.admin.routes',
              'asset_management.app.category.models',
              'asset_management.database.session',
          ]
          
          for module in modules:
              try:
                  importlib.import_module(module)
                  print(f'âœ… {module}')
              except Exception as e:
                  errors.append(f'{module}: {e}')
                  print(f'âŒ {module}: {e}')
          
          if errors:
              print(f'\nâŒ {len(errors)}ê°œ ëª¨ë“ˆì—ì„œ import ì—ëŸ¬ ë°œìƒ!')
              sys.exit(1)
          else:
              print(f'\nâœ… ëª¨ë“  ëª¨ë“ˆ import ì„±ê³µ!')
          "

  app-startup-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install -e .
      
      - name: FastAPI ì•± ì‹œì‘ í…ŒìŠ¤íŠ¸
        env:
          # í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ ë³€ìˆ˜ (ì‹¤ì œ DB ì—°ê²° ì—†ì´)
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
          SECRET_KEY: "test-secret-key-for-ci"
          GOOGLE_CLIENT_ID: "test-client-id"
          GOOGLE_CLIENT_SECRET: "test-client-secret"
        run: |
          echo "ğŸš€ FastAPI ì•± ì‹œì‘ ê²€ì¦..."
          python -c "
          import sys
          try:
              from asset_management.main import app
              
              # FastAPI ì•± ê°ì²´ ê²€ì¦
              assert app is not None, 'appì´ Noneì…ë‹ˆë‹¤'
              assert hasattr(app, 'routes'), 'routes ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤'
              
              # ë¼ìš°í„° ë“±ë¡ í™•ì¸
              route_paths = [route.path for route in app.routes]
              print(f'ë“±ë¡ëœ ë¼ìš°íŠ¸ ìˆ˜: {len(route_paths)}')
              
              # í•„ìˆ˜ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
              required_endpoints = ['/health', '/api']
              for endpoint in required_endpoints:
                  if any(endpoint in path for path in route_paths):
                      print(f'âœ… {endpoint} ì—”ë“œí¬ì¸íŠ¸ í™•ì¸')
                  else:
                      print(f'âš ï¸ {endpoint} ì—”ë“œí¬ì¸íŠ¸ ë¯¸í™•ì¸')
              
              print('âœ… FastAPI ì•± ë¡œë“œ ì„±ê³µ!')
          except Exception as e:
              print(f'âŒ FastAPI ì•± ë¡œë“œ ì‹¤íŒ¨: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
      
      - name: OpenAPI ìŠ¤í‚¤ë§ˆ ìƒì„± í…ŒìŠ¤íŠ¸
        env:
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
          SECRET_KEY: "test-secret-key-for-ci"
          GOOGLE_CLIENT_ID: "test-client-id"
          GOOGLE_CLIENT_SECRET: "test-client-secret"
        run: |
          echo "ğŸ“„ OpenAPI ìŠ¤í‚¤ë§ˆ ìƒì„± í…ŒìŠ¤íŠ¸..."
          python -c "
          from asset_management.main import app
          schema = app.openapi()
          assert 'paths' in schema, 'OpenAPI ìŠ¤í‚¤ë§ˆì— pathsê°€ ì—†ìŠµë‹ˆë‹¤'
          assert 'info' in schema, 'OpenAPI ìŠ¤í‚¤ë§ˆì— infoê°€ ì—†ìŠµë‹ˆë‹¤'
          print(f'âœ… OpenAPI ìŠ¤í‚¤ë§ˆ ìƒì„± ì„±ê³µ ({len(schema[\"paths\"])} ì—”ë“œí¬ì¸íŠ¸)')
          "

  test:
    runs-on: ubuntu-latest
    needs: [import-check]  # import ì²´í¬ í†µê³¼ í›„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-asyncio httpx aiosqlite
      
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          DATABASE_URL: "mysql+aiomysql://root:test_password@localhost:3306/test_db"
          SECRET_KEY: "test-secret-key"
          GOOGLE_CLIENT_ID: "test-client-id"
          GOOGLE_CLIENT_SECRET: "test-client-secret"
        run: |
          echo "ğŸ§ª pytest ì‹¤í–‰..."
          pytest tests/ -v --tb=short

  # ëª¨ë“  ì²´í¬ í†µê³¼ í™•ì¸ (Branch Protectionì— ì‚¬ìš©)
  ci-success:
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, import-check, app-startup-check, test]
    steps:
      - name: CI ì„±ê³µ
        run: echo "âœ… ëª¨ë“  CI ì²´í¬ í†µê³¼!"
